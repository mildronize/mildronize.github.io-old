{"componentChunkName":"component---src-templates-post-short-url-jsx","path":"/s/c2tcmvl/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>Update วันที่ 24 Dec 2022:\nเพิ่ม Step ที่ 5 ใช้ Alpine เป็น base image และลบ Prisma ไฟล์บางอย่างที่ไม่ได้ใช้งานออก</p>\n</blockquote>\n<p>เจ็บปวดกันมาเท่าไหร่กับ ขนาดของ project nodejs ที่ใหญ่มโหฬาร วันนี้ผมจะมาแชร์ประสบการณ์ Workaround ของผมว่าจะลด 80% ได้ยังไง ด้วย esbuild Bundle</p>\n<p><strong>Before</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG           IMAGE ID       CREATED       SIZE\nremote-state-api      debian        f42e4b8e75cb   4 days ago    2.64GB</code></pre></div>\n<p><strong>After</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG            IMAGE ID       CREATED           SIZE\nremote-state-api      alpine-unused  12b08b0bfc1f   8 seconds ago     77.8MB</code></pre></div>\n<p>โดยสรุปลดจาก 2.64 GB เหลือ 77.8 MB โดยลดไปประมาณ 97%</p>\n<h2>Stack ที่ใช้</h2>\n<ul>\n<li><a href=\"https://www.prisma.io/\">Prisma</a> 4.8.0</li>\n<li><a href=\"https://nestjs.com/\">Nestjs</a> 9.0.0</li>\n<li><a href=\"https://nx.dev/\">Nx</a> (Monorepo Tools) 15.3.3</li>\n</ul>\n<p>ถ้าเราเริ่มต้นใช้งาน Nestjs แล้วเริ่มต้นติดตั้ง node_modules ขนาดของ</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">du -sh ./node_modules\n495M   ./node_modules</code></pre></div>\n<p>แล้วถ้าเราใช้ Nx เพื่อกำหนดโครงสร้าง Monorepo ใน repo ของเรามันจะทำให้ใน node_modules ของเราใหญ่ขึ้นมากๆ โดยไม่จำเป็น\nซึ่ง Nx จะมี mode ให้ใช้หลักๆ อยู่ 2 แบบ คือ</p>\n<ol>\n<li>\n<p><a href=\"https://nx.dev/getting-started/package-based-repo-tutorial\">Package-Based Repos</a> อันนี้จะเป็นแนวเวลาเราใช้งาน monorepo ทั่วๆ ไป โดยที่แต่ละ project จะมี <code class=\"language-text\">package.json</code> แยกกันเลย จึงทำให้เราสามารถจัดการแต่ละ project แยกกันง่าย และเวลา deploy package แต่ละ Project จะไม่ปนกัน</p>\n<ul>\n<li>แต่ข้อเสียคือ การ config ให้ tsconfig, eslint, jest ให้มีการใช้งานร่วมกันระหว่างโปรเจ็คได้ ค่อนข้างใช้เวลาเยอะ และ เราไม่สามารถใช้ความสามารถ Generator ของ Nx ได้ ที่สามารถเสก Template TypeScript Project ง่ายๆ</li>\n<li>ตัวอย่าง Monorepo ที่ลักษณะคล้ายๆ กันก็คือจะมี <a href=\"https://yarnpkg.com/features/workspaces\">Yarn Workspace</a>, <a href=\"https://pnpm.io/workspaces\">pnpm Workspace</a>, <a href=\"https://github.com/lerna/lerna\">Lerna</a>, <a href=\"https://turbo.build/repo\">turborepo</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://nx.dev/getting-started/integrated-repo-tutorial\">Integrated Repos</a> อันนี้จะเป็นลักษณะพิเศษที่จะมีเฉพาะ Nx อย่างที่บอกไปแล้วว่าข้อดีคือ สามารถใช้ความสามารถ Generator ของ Nx ได้ ที่สามารถเสก Template TypeScript Project ง่ายๆ พร้อม config ที่เราใช้งานโดยทั่วไปคือ tsconfig, eslint และ jest</p>\n<ul>\n<li>แต่ข้อเสียคือ Learning Curve สูงกว่าแบบแรกแน่นอน แต่อย่าลืมว่า การ config ให้ tsconfig, eslint, jest ให้มีการใช้งานร่วมกันระหว่างโปรเจ็คได้ ก็ใช้เวลาเยอะเช่นกัน</li>\n<li>อีกข้อดีและข้อเสีย ก็คือการที่มี package.json ที่เดียวในตำแหน่ง root ของ repo เท่านั้น ซึ่งข้อดีก็คือทำให้เราจัดการ package version ไม่ซ้ำซ้อนกัน เช่น Library ที่ใช้งานร่วมกันก็ควรมี dependencies ที่มี version เดียวกัน ดังนั้นการเปลี่ยน version ทุก project จึงเป็นเรื่องไม่ค่อยอยากทำ ส่วนข้อเสียก็คือ เวลาเราจะ deploy หรือ publish บาง project ขนาดของ node_modules จะอ้วนมากๆ</li>\n<li>ตัวอย่าง Template ที่ Nx มีให้ใช้ก็เยอะมากๆ หลักๆ คือ React, Angular, Vue, Nestjs และพวก Library Project ต่างๆ ดู plugin ทั้งหมดได้ใน <a href=\"https://nx.dev/packages\">Nx Packages</a></li>\n</ul>\n</li>\n</ol>\n<h3>จากมีมที่เค้าชอบแซวๆ กันใน node_modules</h3>\n<p>ใน Project นี้เราจะจึง Stack ที่มีแต่ทำให้ node_modules บวมๆ ขึ้นมากๆ</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/70ebf207b6e413a8914d64afb84fb33d/7a3d6/node-modules-too-big.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0UlEQVQoz6WR8U/aUBDH+yf6v+1XExdww6FAkbAxhqI0RsHCcFC1sPZZaCt9FLAt2Ja+924pZG5hmC3Z94fL3eU+3+TuOAC4M72S9JSvK4I8zouDwlWvUP9+XO8Xm9rhRa/cUvnLvmJ57f4wWb0tNdV07Vb4pi6XITeYPJc71gC1O2jEf7VKHetSeVJtX+jPPnZw5c4udcfXyCncjPrYr/Vmn7vjBnLL0mTsLbmQgjJyRl92uq3iNARKyb3pFtuPKvbCiDLGBHm8e46eQ7IICTBWkXDyQlsEURhRDlayJzgIgnU+mYd7tYcgouuyozvvr4YAEBEGACKa5ZomABDKOMaAxc04Ehpnthe+OUVLQlcVdHXnQ+MX3FBnfOsnDL9pNQzzkHxSHBqbxg0phvUYXpldo1fgDdH/h7t/hX3fxxi7rjudTi2MbduO1isCSIZ7JJrbYcYopVSW75PJRCqVyuWyiUQim8mMLBwRAgA32uTtmfxysA2Y5fnc/rv9crlyVq02RFEUGzWhVj09OTzKMMoG+mPp5DyeJnQLDABIRXyOLxSOs5lMOp1OHRyo6GH1P7Zxgi07LxYL0zSHQ90wDNMwNE3z5vMXeO3wKvwv+hP+AXXP/8ggIIzYAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Ref: https://tsh.io/blog/reduce-node-modules-for-better-performance/\"\n        title=\"Ref: https://tsh.io/blog/reduce-node-modules-for-better-performance/\"\n        src=\"/static/70ebf207b6e413a8914d64afb84fb33d/8c557/node-modules-too-big.png\"\n        srcset=\"/static/70ebf207b6e413a8914d64afb84fb33d/4edbd/node-modules-too-big.png 175w,\n/static/70ebf207b6e413a8914d64afb84fb33d/13ae7/node-modules-too-big.png 350w,\n/static/70ebf207b6e413a8914d64afb84fb33d/8c557/node-modules-too-big.png 700w,\n/static/70ebf207b6e413a8914d64afb84fb33d/7a3d6/node-modules-too-big.png 990w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>ต่อๆ</h2>\n<p>ดังนั้นผมจึงเลือก Integrated Repos ของ Nx มาใช้ในงานนี้ อย่างที่บอกไปว่า Nx แบบ Integrated Repos นั้น ทำให้มี node_modules บางตัวที่ไม่ได้ใช้งาน การที่เราจะ Deploy หรือ Publish ทำให้ขนาดของแอพใหญ่ขึ้นมากๆ <a href=\"https://github.com/nrwl/nx/issues/1777\">nrwl/nx Issues#177</a></p>\n<h2>Step 1: First Docker Image</h2>\n<p>จากที่แสดงข้างบนบทความจะเห็นได้ว่าแอพตัวนี้มีขนาด 2.64GB</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG           IMAGE ID       CREATED       SIZE\nremote-state-api      debian        f42e4b8e75cb   4 days ago    2.64GB</code></pre></div>\n<p>โดยเรามีการใช้งาน image <code class=\"language-text\">node:18</code> แค่ Image เปล่าๆ ก็ขนาด 942 MB เข้าไปแล้ว</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG       IMAGE ID       CREATED        SIZE\nnode                  18        c6b41dff69c8   20 hours ago   942MB</code></pre></div>\n<p>แสดงว่าแอพของเราไม่รวม base image จะมีขนาดประมาณ 1.72 GB โอ้วแม่เจ้า อะไรจะใหญ่ขนาดนี้</p>\n<h3>ตัวอย่าง Dockerfile ที่ใช้ใน Step นี้</h3>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18 As development\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>f https<span class=\"token punctuation\">:</span>//get.pnpm.io/v6.16.js <span class=\"token punctuation\">|</span> node <span class=\"token punctuation\">-</span> add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global pnpm\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> ./dist/apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server .\n<span class=\"token keyword\">COPY</span> apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server/prisma ./prisma/\n<span class=\"token keyword\">COPY</span> package.json pnpm<span class=\"token punctuation\">-</span>lock.yaml ./\n<span class=\"token keyword\">ENV</span> PORT=3333\n<span class=\"token keyword\">EXPOSE</span> $<span class=\"token punctuation\">{</span>PORT<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">RUN</span> pnpm fetch <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>prod\n<span class=\"token keyword\">RUN</span> pnpm install\n<span class=\"token keyword\">RUN</span> pnpx prisma generate\n<span class=\"token comment\"># We don't have the existing sqlite file</span>\n<span class=\"token comment\"># So, we will create a fresh sqlite every time when build</span>\n<span class=\"token comment\"># This migration should be run every time when build</span>\n<span class=\"token keyword\">RUN</span> pnpx prisma migrate deploy\n<span class=\"token keyword\">CMD</span> node ./main.js</code></pre></div>\n<p>ซึ่งใน Dockerfile นี้ผมไม่ได้ Build ใน Docker แต่จะ Build ที่เครื่อง Host ให้เสร็จแล้ว copy เข้ามาตอน build แทน ซึ่งก่อน Build ผมจะรัน</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">nx run remote-state-server:build:production</code></pre></div>\n<p>ป.ล. <code class=\"language-text\">remote-state-server:build:production</code> ตัวนี้เป็น executor default ของ template Nestjs โดยจะใช้ executor ที่ชื่อว่า <a href=\"https://nx.dev/packages/webpack/executors/webpack\">@nrwl/webpack:webpack</a></p>\n<p>โดยใน Docker Image ผมจะมีการรัน <code class=\"language-text\">prisma generate</code> เพื่อรัน <a href=\"https://www.prisma.io/docs/concepts/components/prisma-client/working-with-prismaclient/generating-prisma-client\">script postinstall ของ Prisma เอง</a> และรัน <code class=\"language-text\">prisma migrate deploy</code> ทุกครั้งที่ Build เพราะผมใช้ Sqlite ใน image นี้ด้วย และต้องการให้มัน clean ทุกครั้งที่ build ส่วนใครที่ไม่ใช้งานสามารถลบออกไปได้คับ</p>\n<h2>Step 2: สวัสดี Alpine Image</h2>\n<p>ใน Step นี้ผมจะใช้ Docker multi-stage และติดตั้งเฉพาะ dependencies สำหรับ Production อย่างเดียว ซึ่งผมจะไม่ลงรายละเอียด แต่ไปศึกษาเพิ่มเติมกันได้ <a href=\"https://www.tomray.dev/nestjs-docker-production\">How to write a NestJS Dockerfile optimized for production</a></p>\n<p>เมื่อเสร็จสิ้นกระบวนการ จะได้ขนาด Image ประมาณ 1.18 GB</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG           IMAGE ID       CREATED       SIZE\nremote-state-api      alpine        f42e4b8e75cb   4 days ago    1.18GB</code></pre></div>\n<p>เมื่อเราเช็คขนาด Image ของ Alpine จะอยู่ที่ 167 MB</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG           IMAGE ID       CREATED       SIZE\nnode                  18-alpine   8a6b96edfa16   9 days ago     167MB</code></pre></div>\n<p>แสดงว่าแอพของเราไม่รวม base image จะมีขนาดประมาณ 1 GB อันนี้คือ Nx ที่รวม node_modules ทุก Project ที่อยู่ใน monorepo เดียวกันเลย แสดงว่า devDependencies จะอยู่ที่ประมาณ 700 MB เลยทีเดียว</p>\n<h3>ตัวอย่าง Dockerfile</h3>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\">###################</span>\n<span class=\"token comment\"># BUILD FOR DEVELOPMENT</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18 As development\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>f https<span class=\"token punctuation\">:</span>//get.pnpm.io/v6.16.js <span class=\"token punctuation\">|</span> node <span class=\"token punctuation\">-</span> add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global pnpm\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node . .\n<span class=\"token keyword\">RUN</span> pnpm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n<span class=\"token keyword\">RUN</span> pnpx nx run remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">:</span>build<span class=\"token punctuation\">:</span>production\n<span class=\"token keyword\">USER</span> node\n\n<span class=\"token comment\">###################</span>\n<span class=\"token comment\"># BUILD FOR PRODUCTION</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18 As build\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>f https<span class=\"token punctuation\">:</span>//get.pnpm.io/v6.16.js <span class=\"token punctuation\">|</span> node <span class=\"token punctuation\">-</span> add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global pnpm\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node package.json pnpm<span class=\"token punctuation\">-</span>lock.yaml ./\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server/prisma ./prisma/\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=development /app/dist/apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server .\n<span class=\"token keyword\">ENV</span> NODE_ENV production\n<span class=\"token keyword\">RUN</span> pnpm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>prod <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n<span class=\"token keyword\">USER</span> node\n\n<span class=\"token comment\">###################</span>\n<span class=\"token comment\"># PRODUCTION</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18<span class=\"token punctuation\">-</span>alpine As production\n\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=build /app .\n\n<span class=\"token keyword\">RUN</span> apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>update <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache openssl1.1<span class=\"token punctuation\">-</span>compat curl\n<span class=\"token comment\"># We don't have the existing sqlite file</span>\n<span class=\"token comment\"># So, we will create a fresh sqlite every time when build</span>\n<span class=\"token comment\"># This migration should be run every time when build</span>\n<span class=\"token keyword\">RUN</span> npx prisma migrate deploy\n<span class=\"token comment\"># Prepare prima library</span>\n<span class=\"token keyword\">RUN</span> npx prisma generate\n\n<span class=\"token comment\"># Clean up with https://github.com/tj/node-prune</span>\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>sf https<span class=\"token punctuation\">:</span>//gobinaries.com/tj/node<span class=\"token punctuation\">-</span>prune <span class=\"token punctuation\">|</span> sh\n\n<span class=\"token comment\"># Run cleanup necessary dependencies Ref: Fix npm by https://bobbyhadz.com/blog/npm-fix-the-upstream-dependency-conflict-installing-npm-packages</span>\n<span class=\"token comment\"># RUN npm prune --force --legacy-peer-deps --production</span>\n<span class=\"token keyword\">RUN</span> /usr/local/bin/node<span class=\"token punctuation\">-</span>prune\n\n<span class=\"token comment\"># remove unused dependencies</span>\n<span class=\"token comment\"># https://tsh.io/blog/reduce-node-modules-for-better-performance/</span>\n<span class=\"token comment\"># https://medium.com/@alpercitak/nest-js-reducing-docker-container-size-4c2672369d30</span>\n<span class=\"token keyword\">RUN</span> rm <span class=\"token punctuation\">-</span>rf node_modules/rxjs/src/\n<span class=\"token keyword\">RUN</span> rm <span class=\"token punctuation\">-</span>rf node_modules/rxjs/bundles/\n<span class=\"token keyword\">RUN</span> rm <span class=\"token punctuation\">-</span>rf node_modules/rxjs/_esm5/\n<span class=\"token keyword\">RUN</span> rm <span class=\"token punctuation\">-</span>rf node_modules/rxjs/_esm2015/\n<span class=\"token keyword\">RUN</span> rm <span class=\"token punctuation\">-</span>rf node_modules/swagger<span class=\"token punctuation\">-</span>ui<span class=\"token punctuation\">-</span>dist/*.map\n\n<span class=\"token keyword\">ENV</span> PORT=3333\n<span class=\"token keyword\">EXPOSE</span> $<span class=\"token punctuation\">{</span>PORT<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">CMD</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"main.js\"</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>ถ้าสังเกตุใน dockerfile จะเห็นได้ว่าผมใช้ <code class=\"language-text\">prisma generate</code> ใน Alpine ซึ่งโดยปกติเราเวลาใช้ Alpine เรามักจะจัดการทุกอย่างให้เสร็จก่อนใน debian image แล้วค่อย copy file มาที่ Alpine</p>\n<p>แต่ Prisma ไม่อนุญาตเรา build ไว้ก่อนใน debian เพราะ OS ไม่ตรงกับที่ runtime ผมเลยจำใจต้องมา build ใน Alpine แทน</p>\n<p>ในการรัน Prisma ใน Alpine นั้นจะขาด libary ที่ชื่อว่า <code class=\"language-text\">openssl1.1-compat</code> ไม่งั้นจะ Error ว่า <strong>\"Error: Unable to establish a connection to query-engine-node-api library. It seems there is a problem with your OpenSSL installation!\"</strong> ขอบคุณ <a href=\"https://github.com/prisma/prisma/issues/14073\">prisma/prisma issues#14073</a></p>\n<h2>Step 3: จัดการ dependencies ที่ไม่เกี่ยวข้องกับโปรเจ็คนั้นๆ ออกไปจาก Nx</h2>\n<p>ซึ่งการที่จะหาว่าใน Project นั้นใช้ dependenies อะไรบ้างนั้น Nx ไม่ได้ให้ Tool สำหรับหา ดังนั้นเราต้องใช้ tool นอก ซึ่งผมจะใช้ <a href=\"https://github.com/depcheck/depcheck\">depcheck</a> ในการรันเช็คใน Project นั้นๆ</p>\n<p>แต่มันก็ไม่ได้ง่ายแบบนั้น เพราะ Nx สามารถเรียก Library ที่อยู่ภายใน Monorepo เดียวกันได้เลย ดังนั้นเราต้องรัน depcheck ทุก project ที่เกี่ยวข้องทั้งหมด แล้วเราจะหาได้ยังไงว่า Project เราใช้ Libary อะไรบ้าง ในเมื่อมันไม่ได้มี package.json แยกแต่ละ project</p>\n<p>เราสามารถหาได้ 2 วิธี</p>\n<ol>\n<li>เราสามารถใช้ <code class=\"language-text\">depcheck</code> เพื่อดู <strong>Missing dependencies</strong> ใน Project เรา ส่วนใหญ่แล้ว Missing dependencies จะเป็นการอ้างอิงภายใน monorepo เดียวกัน เพราะมันไม่ได้อยู่ใน package.json ที่อยู่ root ของ repo</li>\n<li>เราสามารถใช้ tool ของ Nx ในการ <a href=\"https://nx.dev/recipes/other/export-project-graph\">Export Project Graph to JSON</a> ได้โดยใช้ <code class=\"language-text\">nx graph --file=output.json</code></li>\n</ol>\n<p>จากนั้นในบทความหลายๆ ที่ก็แนะนำให้ใช้ <code class=\"language-text\">npm prune</code> และ <a href=\"https://github.com/tj/node-prune\">node-prune</a> และผมก็ได้ลอง</p>\n<ul>\n<li><a href=\"https://medium.com/trendyol-tech/how-we-reduce-node-docker-image-size-in-3-steps-ff2762b51d5a\">How We Reduce Node Docker Image Size In 3 Steps</a></li>\n<li><a href=\"https://tsh.io/blog/reduce-node-modules-for-better-performance/\">Honey, I shrunk the node_modules! ...and improved app’s performance in the process. On node module size</a></li>\n</ul>\n<p>และเมื่อเราได้ dependencies ของทุก project ที่เกี่ยวข้องกันแล้ว เราก็เอา package.json ในแต่ละ project มารวมกันที่เดียวเรา npm install ใหม่เพื่อให้ได้ lock file มา  แล้วเอา 2 files นี้ไป build ใน docker image</p>\n<p>และเมื่อผมทำมาทั้งหมดที่ว่ามาแล้ว ก็จะเหลือขนาด image ประมาณ 831 MB แสดงว่าขนาดแอพเราจะอยู่ที่ 664 MB ซึ่งก็ยังเยอะอยู่ดี</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG             IMAGE ID       CREATED       SIZE\nremote-state-api      alpine-unused   907254a67d28   4 days ago    831MB</code></pre></div>\n<p>ใน Step นี้จะใช้ dockerfile เดียวกันกับ step ที่แล้ว</p>\n<h2>Step 4: Bundle Nestjs โดยใช้ esbuild</h2>\n<p>จริง ผมเคยมีความพยายามจะ Bundle Nestjs ด้วย esbuild หลายครั้งแล้ว ซึ่งเป็นวิธีเดียวกันกับเวลาเรา bundle JS เพื่อใช้ Browser เลย โดยที่เราไม่ต้องใส่ ืnode_modules ลงไปใน docker images เลย เย้ๆ จึงทำให้ขนาดของ Nestjs แอพที่ bundle แล้วจะอยู่ที่ 2.3 MB เท่านั้นเอง โอ้ว เล็กมากๆ</p>\n<p>แต่มัน build แบบ bundle ไม่ผ่านครับ เพราะมันจะบอกว่าเราไม่ได้ลง packages พวก <code class=\"language-text\">cache-manager</code>, <code class=\"language-text\">@nestjs/microservices</code>, <code class=\"language-text\">class-transformer/storage</code> ไว้ ทำให้มันหาไม่เจอ</p>\n<p>เพราะว่า Nestjs มีการเรียกหา packages พวกนั้นด้วย แต่เราไม่ได้ใช้งานนี่สิ ทำไมเราต้องลง ซึ่งใน esbuild เองเราสามารถเอา package ที่เราไม่ต้องการออกจาก bundle ให้ (ก็คือถ้าไม่อยู่ใน bundle มันจะไปหาใน node_modules แทน) โดยการใช้ config ประมาณนี้</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> build<span class=\"token punctuation\">,</span> BuildOptions <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'esbuild'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> buildConfig<span class=\"token operator\">:</span> BuildOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\">// ...</span>\n    external<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'cache-manager'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'@nestjs/microservices'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'class-transformer/storage'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span>buildConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>แต่ว่าเราก็ไม่สามารถทำงานได้อีก รอบนี้ดูเหมือน Depedency Injection ของ Nestjs ไม่ทำงาน ต้องขอบคุณ คุณ Anton Golub ที่เขียน blog เรื่อง <a href=\"https://dev.to/antongolub/nestjs-esbuild-workarounds-99i\">NestJS + esbuild workarounds</a> ซึ่งเค้าได้อธิบายว่า esbuild จะไม่ได้ bundle พวก decorator ให้เรา ดังนั้นเค้าจึงเขียน plugin ใน esbuild ที่ชื่อ <a href=\"https://github.com/anatine/esbuildnx\">@anatine/esbuild-decorators</a> เพื่อมาจัดการตรงนี้</p>\n<p>และผมก็เจอปัญหาลักษณะเดียวกันกับ Prisma เช่นกัน ผมเลยจึงเอา <code class=\"language-text\">prisma</code> และ <code class=\"language-text\">@prisma/client</code> ออกจาก bundle ด้วย แล้วค่อยไปลงใหม่ใน docker build แทน</p>\n<p>โดยในที่สุดก็จะได้ image ขนาด 376 MB หรือถ้าตัด base image ออก จะเหลือ 209 MB</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG            IMAGE ID       CREATED       SIZE\nremote-state-api      alpine-bundle  022a0feda515   4 days ago    376MB</code></pre></div>\n<h2>ตัวอย่าง Dockerfile</h2>\n<p>custom esbuild config</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> program <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'commander'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> build<span class=\"token punctuation\">,</span> BuildOptions <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'esbuild'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> typecheckPlugin <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@jgoz/esbuild-plugin-typecheck'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> esbuildDecorators <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@anatine/esbuild-decorators'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> cwd <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> outfile <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>cwd<span class=\"token punctuation\">,</span> <span class=\"token string\">'output.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> tsconfig <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>cwd<span class=\"token punctuation\">,</span> <span class=\"token string\">'tsconfig.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> isVerbose <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span>verbose <span class=\"token operator\">===</span> <span class=\"token string\">'true'</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">ICommandOption</span> <span class=\"token punctuation\">{</span>\n  output<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  watch<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nprogram\n  <span class=\"token punctuation\">.</span><span class=\"token function\">description</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Script for building atom CLI'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">option</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-w, --watch'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Enable watch mode'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">option</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-o, --output &lt;path>'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'output file'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">action</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> opts <span class=\"token operator\">=</span> program<span class=\"token punctuation\">.</span><span class=\"token function\">opts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> ICommandOption<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      watch<span class=\"token operator\">:</span> opts<span class=\"token punctuation\">.</span>watch <span class=\"token operator\">??</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      output<span class=\"token operator\">:</span> opts<span class=\"token punctuation\">.</span>output <span class=\"token operator\">?</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>opts<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nprogram<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>option<span class=\"token operator\">:</span> ICommandOption<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> config<span class=\"token operator\">:</span> BuildOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    entryPoints<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'apps/remote-state-server/src/main.ts'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    bundle<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    platform<span class=\"token operator\">:</span> <span class=\"token string\">'node'</span><span class=\"token punctuation\">,</span>\n    target<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'node18'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'es2021'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    outdir<span class=\"token operator\">:</span> option<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">,</span>\n    tsconfig<span class=\"token punctuation\">,</span>\n    plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token function\">typecheckPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">esbuildDecorators</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        tsconfig<span class=\"token punctuation\">,</span>\n        cwd<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> buildConfig<span class=\"token operator\">:</span> BuildOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    external<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'commander'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'cache-manager'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'@nestjs/microservices'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'prisma'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'@prisma/client'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'kafkajs'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'mqtt'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'amqplib'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'amqp-connection-manager'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'nats'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'@grpc/grpc-js'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'@grpc/proto-loader'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'@nestjs/websockets/socket-module'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'class-transformer/storage'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>config<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> developConfig<span class=\"token operator\">:</span> BuildOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>config<span class=\"token punctuation\">,</span>\n    external<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'commander'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    watch<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      onRebuild<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">await</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">.</span>watch <span class=\"token operator\">?</span> developConfig <span class=\"token operator\">:</span> buildConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">onRebuild</span><span class=\"token punctuation\">(</span>error<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> result<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'watch build failed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isVerbose<span class=\"token punctuation\">)</span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">' watch build succeeded '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>project.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// project.json</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"targets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"build-esbuild\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"executor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nx:run-commands\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"options\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"tsx src/scripts/build.ts --output '../../dist/apps/remote-state-server'\"</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"parallel\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"cwd\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"apps/remote-state-server\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Dockerfile</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\">###################</span>\n<span class=\"token comment\"># BUILD</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18 As development\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>f https<span class=\"token punctuation\">:</span>//get.pnpm.io/v6.16.js <span class=\"token punctuation\">|</span> node <span class=\"token punctuation\">-</span> add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global pnpm\n\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node . .\n<span class=\"token keyword\">RUN</span> pnpm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n<span class=\"token keyword\">RUN</span> pnpx nx run remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">:</span>build<span class=\"token punctuation\">-</span>esbuild\n<span class=\"token keyword\">USER</span> node\n\n<span class=\"token comment\">###################</span>\n<span class=\"token comment\"># Install Dependencies</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18 As build\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>f https<span class=\"token punctuation\">:</span>//get.pnpm.io/v6.16.js <span class=\"token punctuation\">|</span> node <span class=\"token punctuation\">-</span> add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global pnpm\n\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server/prisma ./prisma/\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=development /app/dist/apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server .\n<span class=\"token keyword\">ENV</span> NODE_ENV production\n<span class=\"token keyword\">RUN</span> pnpm install @prisma/client@^4.7.1\n<span class=\"token keyword\">USER</span> node\n\n<span class=\"token comment\">###################</span>\n<span class=\"token comment\"># PRODUCTION</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18<span class=\"token punctuation\">-</span>alpine As production\n\n<span class=\"token keyword\">WORKDIR</span> /app\n\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=build /app .\n\n<span class=\"token comment\"># For Prisma client in Alpine</span>\n<span class=\"token comment\"># Fix \"Error: Unable to establish a connection to query-engine-node-api library. It seems there is a problem with your OpenSSL installation!\"</span>\n<span class=\"token comment\"># Ref: https://github.com/prisma/prisma/issues/14073</span>\n<span class=\"token keyword\">RUN</span> apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>update <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache openssl1.1<span class=\"token punctuation\">-</span>compat\n\n<span class=\"token comment\"># We don't have the existing sqlite file</span>\n<span class=\"token comment\"># So, we will create a fresh sqlite every time when build</span>\n<span class=\"token comment\"># This migration should be run every time when build</span>\n<span class=\"token keyword\">RUN</span> npx prisma migrate deploy\n<span class=\"token comment\"># Prepare prima library</span>\n<span class=\"token keyword\">RUN</span> npx prisma generate\n\n<span class=\"token keyword\">ENV</span> PORT=3333\n<span class=\"token keyword\">EXPOSE</span> $<span class=\"token punctuation\">{</span>PORT<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">CMD</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"main.js\"</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Step 5: ใช้ Alpine เปล่าๆ และลบไฟล์ไม่จำเป็นออก</h2>\n<p>ใน Step นี้ เปลี่ยนไปใช้ alpine base image แล้วก็ลง nodejs เอง ลบไฟล์ที่ไม่จำเป็นออกทั้งหมด แล้วก็ติดตั้ง Prisma version โดยอ่านจาก <code class=\"language-text\">package.json</code> ไฟล์ รวมถึง set user เป็น non root</p>\n<p>แล้วก็ใช้ <a href=\"https://github.com/wagoodman/dive\">dive</a> ในการวิเคราะห์ในแต่ละ Layer ว่ามีไฟล์อะไรอยู่บ้าง จะได้ลบไฟล์ที่ไม่ได้ใช้ออกไป</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\">###################</span>\n<span class=\"token comment\"># BUILD FOR PRODUCTION</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token keyword\">FROM</span> node<span class=\"token punctuation\">:</span>18 As build\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>f https<span class=\"token punctuation\">:</span>//get.pnpm.io/v6.16.js <span class=\"token punctuation\">|</span> node <span class=\"token punctuation\">-</span> add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global pnpm\n\n<span class=\"token keyword\">WORKDIR</span> /app\n\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node . .\n\n<span class=\"token keyword\">RUN</span> pnpm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile\n\n<span class=\"token keyword\">RUN</span> pnpx nx run remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">:</span>build<span class=\"token punctuation\">-</span>esbuild\n\n<span class=\"token keyword\">USER</span> node\n\n<span class=\"token comment\">###################</span>\n<span class=\"token comment\"># PRODUCTION</span>\n<span class=\"token comment\">###################</span>\n\n<span class=\"token comment\"># Not Natively support ARM64 (M1)</span>\n<span class=\"token keyword\">FROM</span> alpine<span class=\"token punctuation\">:</span>3.17 As production\n\n<span class=\"token keyword\">ENV</span> PORT=3333\n<span class=\"token keyword\">ENV</span> NODE_VERSION 18.12.1<span class=\"token punctuation\">-</span>r0\n<span class=\"token keyword\">ENV</span> NPM_VERSION 9.1.2<span class=\"token punctuation\">-</span>r0\n<span class=\"token keyword\">ENV</span> OPENSSL_COMPAT_VERSION 1.1.1s<span class=\"token punctuation\">-</span>r0\n\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node package.json .\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server/prisma ./prisma/\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>chown=node<span class=\"token punctuation\">:</span>node <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=build /app/dist/apps/remote<span class=\"token punctuation\">-</span>state<span class=\"token punctuation\">-</span>server .\n\n<span class=\"token keyword\">RUN</span> apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>update <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache nodejs=$NODE_VERSION\n\n<span class=\"token keyword\">RUN</span> apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>update <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache \\\n  <span class=\"token comment\"># For getting node-prune</span>\n  curl \\\n  <span class=\"token comment\"># For Prisma client in Alpine</span>\n  <span class=\"token comment\"># Fix \"Error: Unable to establish a connection to query-engine-node-api library. It seems there is a problem with your OpenSSL installation!\"</span>\n  <span class=\"token comment\"># Ref: https://github.com/prisma/prisma/issues/14073</span>\n  openssl1.1<span class=\"token punctuation\">-</span>compat=$OPENSSL_COMPAT_VERSION \\\n  npm=$NPM_VERSION \\\n  <span class=\"token comment\"># npx will look the local node_modules first, if not it will install globally</span>\n  <span class=\"token comment\"># Ref: https://stackoverflow.com/questions/22420564/install-only-one-package-from-package-json</span>\n  &amp;&amp; PRISMA_CLIENT_VERSION=$(node <span class=\"token punctuation\">-</span>pe <span class=\"token string\">\"require('./package').dependencies['@prisma/client']\"</span>) \\\n  &amp;&amp; PRISMA_VERSION=$(node <span class=\"token punctuation\">-</span>pe <span class=\"token string\">\"require('./package').dependencies['prisma']\"</span>) \\\n  <span class=\"token comment\"># We don't need package.json anymore</span>\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf package.json \\\n  &amp;&amp; npm install @prisma/client@$PRISMA_CLIENT_VERSION \\\n  &amp;&amp; npm install <span class=\"token punctuation\">-</span>D prisma@$PRISMA_VERSION \\\n  <span class=\"token comment\"># We don't have the existing sqlite file</span>\n  <span class=\"token comment\"># So, we will create a fresh sqlite every time when build</span>\n  <span class=\"token comment\"># This migration should be run every time when build</span>\n  &amp;&amp; npx prisma migrate deploy \\\n  <span class=\"token comment\"># Prepare prisma library</span>\n  <span class=\"token comment\"># If we don't have package.json, prisma will create for you, and create a local node_modules</span>\n  &amp;&amp; npx prisma generate \\\n  <span class=\"token comment\"># Prune non-used files</span>\n  &amp;&amp; npm prune <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>production \\\n  <span class=\"token comment\"># Clean Prisma non-used files https://github.com/prisma/prisma/issues/11577</span>\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf node_modules/.cache/ \\\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf node_modules/@prisma/engines/ \\\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf node_modules/@prisma/engines<span class=\"token punctuation\">-</span>version \\\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf node_modules/prisma \\\n  <span class=\"token comment\"># Remove cache</span>\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf /root/.cache/ \\\n  &amp;&amp; rm <span class=\"token punctuation\">-</span>rf /root/.npm/ \\\n  <span class=\"token comment\"># Remove all unused dependecies</span>\n  &amp;&amp; apk del openssl1.1<span class=\"token punctuation\">-</span>compat npm curl\n\n<span class=\"token keyword\">EXPOSE</span> $<span class=\"token punctuation\">{</span>PORT<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Create a group and user</span>\n<span class=\"token keyword\">RUN</span> addgroup <span class=\"token punctuation\">-</span>g 1000 node \\\n    &amp;&amp; adduser <span class=\"token punctuation\">-</span>u 1000 <span class=\"token punctuation\">-</span>G node <span class=\"token punctuation\">-</span>s /bin/sh <span class=\"token punctuation\">-</span>D node\n\n<span class=\"token keyword\">USER</span> node\n\n<span class=\"token keyword\">CMD</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"main.js\"</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<h2>สรุป</h2>\n<p>โดยในที่สุดก็จะได้ image ขนาด 77 MB เมื่อตัด runtime ทุกอย่างออก ตัว node app จะเหลือที่ 25 MB (ดูใน dive)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">REPOSITORY            TAG            IMAGE ID       CREATED           SIZE\nremote-state-api      alpine-unused  12b08b0bfc1f   8 seconds ago     77.8MB</code></pre></div>\n<p>พอได้ใช้ <code class=\"language-text\">dive</code> ส่องดูก็พบว่า ขนาดเล็กกำลังดีเลย</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b3a62840fc9f590019277f1ed834a41/a5120/final-image-with-dive.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.85714285714286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACMElEQVQoz32SW2/aQBCF+f9/olXUB0heApSCGiUKKFJbSoqUJiVEIhIXY4zv3vXa6wtfZdOg9qUjjWZ3Z86Z0Z5pFLogUYoizymKgiJJ0LaNchxUEJAphVytkJaFjGNUHBNFEUIIhOMQmiZivUbsdnW+MTa/YK2WbBevWOs1gWGg9nvKsqSUktx1yVyX78Mh/f6AwWDAoN/n82WbTrPF9O6OPI7JtCbPcxoXuyb21sDeGJjLJe5uR2DbhK5LYpoozyOREsex8AMPKQVB4BH4DtvtmsB3+dsanfsm37odJr1PTHo9xt2PfO10+NbpMq7vXSbdLpvpPUng1SCtU7JcE4Q+vu9SlgUc4HA40NgvLH5M7vn58MCvx0fmzzOeZzPmsxlPT488TacsxmPM9Qbh+aSOQxxFZFmOlDFRePzPympClSp0lhFGEanWR2HK8uhFSXE4kEYRwWKBWC7JpEQpVRMGQXAiOxGapolhGPi+jxQSKWVd9KakFIJYJew3GyLLojwcSKpN0LrGVHVvZDWhYzvs93viOD6ughB/JsjqtyqmaYpXNYzjWv0qr3WG53n1AP+IUnWrOoVheCI9AnQ9SUVWuWPbdV2e5SipUELhuz4iFOQ6P3mj2p0KWMX/WT1pkh7PZJSUpKRoNHEp8RKPfWTRGA2HnJ2dcX5+TqvVot1uc319ze3wlpubG66urhiNRvR6PS67lwx7Q1atFcaFwaq5Yt1a8/phwcu7F+bv5/wGcxU0lQ9gtIMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"final image with dive\"\n        title=\"final image with dive\"\n        src=\"/static/3b3a62840fc9f590019277f1ed834a41/8c557/final-image-with-dive.png\"\n        srcset=\"/static/3b3a62840fc9f590019277f1ed834a41/4edbd/final-image-with-dive.png 175w,\n/static/3b3a62840fc9f590019277f1ed834a41/13ae7/final-image-with-dive.png 350w,\n/static/3b3a62840fc9f590019277f1ed834a41/8c557/final-image-with-dive.png 700w,\n/static/3b3a62840fc9f590019277f1ed834a41/e996b/final-image-with-dive.png 1050w,\n/static/3b3a62840fc9f590019277f1ed834a41/2cefc/final-image-with-dive.png 1400w,\n/static/3b3a62840fc9f590019277f1ed834a41/a5120/final-image-with-dive.png 2380w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ป.ล. ได้มีการลองใช้ Distroless ของ Google ด้วยแต่ยังติดปัญหากับ Prisma ถ้าใครรู้วิธีก็มาแชร์กันได้น้าา</p>\n<h2>Acknowledgement</h2>\n<p>ขอบคุณคุณ <a href=\"https://www.facebook.com/neutrons\">Neutron Soutmun</a> ใน Facebook Group Docker in Thai มากๆ เลยคับ พอดีไม่ได้จับ Docker นาน <a href=\"https://www.facebook.com/photo?fbid=10230189576151414&#x26;set=gm.6041709002535607&#x26;idorvanity=858633044176588\">เลยสงสัยว่าทำไมลบไฟล์ใน Dockerfile ไปแล้ว ทำไมขนาดของ image ถึงไม่เล็กลง</a></p>\n<blockquote>\n<p>Docker image จะทำ RUN บน storage layer คนละ layer ครับ\nlayer ที่ทำผ่านไปแล้ว ด้วย RUN ก่อนหน้า จะคงอยู่อย่างนั้น เปลี่ยนแปลงไม่ได้ ด้วย RUN ที่ตามหลังมาครับ</p>\n<p>ถ้าคาดหวังจะให้ files ถูกลบ ต้องทำภายใน RUN หรือ layer เดียวกันกับ layer ที่ files นั้น ๆ ถูกเพิ่มเข้ามาครับ\nRUN touch test.txt &#x26;&#x26; rm -rf test.txt\nBy <a href=\"https://www.facebook.com/neutrons\">Neutron Soutmun</a></p>\n</blockquote>\n<h2>แหล่งอ้างอิง</h2>\n<h3>Docker</h3>\n<ul>\n<li>Multi-Stage: <a href=\"https://www.tomray.dev/nestjs-docker-production\">https://www.tomray.dev/nestjs-docker-production</a></li>\n<li>Best Practice: <a href=\"https://snyk.io/blog/10-best-practices-to-containerize-nodejs-web-applications-with-docker/\">https://snyk.io/blog/10-best-practices-to-containerize-nodejs-web-applications-with-docker/</a></li>\n<li>Reduce File Size Node.js: <a href=\"https://medium.com/trendyol-tech/how-we-reduce-node-docker-image-size-in-3-steps-ff2762b51d5a\">https://medium.com/trendyol-tech/how-we-reduce-node-docker-image-size-in-3-steps-ff2762b51d5a</a></li>\n<li>Honey, I shrunk the node_modules! ...and improved app’s performance in the process. On node module size: <a href=\"https://tsh.io/blog/reduce-node-modules-for-better-performance/\">https://tsh.io/blog/reduce-node-modules-for-better-performance/</a></li>\n</ul>\n<h3>Docker Read more</h3>\n<ul>\n<li><a href=\"https://medium.com/swlh/nx-nestjs-react-docker-deploys-928a55fc19fd\">https://medium.com/swlh/nx-nestjs-react-docker-deploys-928a55fc19fd</a></li>\n<li><a href=\"https://www.codefeetime.com/post/using-docker-compose-with-nx-monorepo-for-multi-apps-development/\">https://www.codefeetime.com/post/using-docker-compose-with-nx-monorepo-for-multi-apps-development/</a></li>\n</ul>\n<h3>Kube</h3>\n<ul>\n<li><a href=\"https://creotip.io/posts/nx-monorepo-running-microservices-locally-with-docker-kubernetes\">https://creotip.io/posts/nx-monorepo-running-microservices-locally-with-docker-kubernetes</a></li>\n</ul>\n<h3>BFF</h3>\n<ul>\n<li><a href=\"https://github.com/mildronize/bff-demo\">https://github.com/mildronize/bff-demo</a></li>\n</ul>","timeToRead":13,"excerpt":"Update วันที่ 24 Dec 2022:\nเพิ่ม Step ที่ 5 ใช้ Alpine เป็น base image และลบ Prisma…","frontmatter":{"title":"ลดขนาด Docker Image ของ NestJS/Prisma กับ Nx Monorepo ประมาณ 97% ด้วย esbuild Bundle","date":null,"category":null,"tags":["Nest.js","Docker","esbuild","monorepo","nx"],"unsplashImgCoverId":"jOqJbvo1P9g"},"fields":{"slug":"c2tcmvl","date":"2022-12-22","readableSlug":"ลดขนาด-docker-image-ของ-nest-js-prisma-กับ-nx-monorepo-ประมาณ-97-ด้วย-esbuild-bundle","isDraft":false,"shortPathname":"/s/c2tcmvl/"}},"allMarkdownRemark":{"edges":[{"node":{"fields":{"slug":"we3xr8r","renderedPathname":"/how-to-setup-this-blog-we3xr8r/"}}},{"node":{"fields":{"slug":"91bu9k0","renderedPathname":"/simple-soap-client-and-simple-server-via-flask-91bu9k0/"}}},{"node":{"fields":{"slug":"hm371bt","renderedPathname":"/my-blog-development-for-jekyll-site-hm371bt/"}}},{"node":{"fields":{"slug":"928lrr0","renderedPathname":"/การแทนตัวอักษรภาษาไทยในระบบการเข้ารหัสแบบต่างๆ-928lrr0/"}}},{"node":{"fields":{"slug":"e52fdze","renderedPathname":"/มาอัพเดท-debian-จากเวอร์ชั่น-stable-มาเป็น-sid-กันเถอะ-e52fdze/"}}},{"node":{"fields":{"slug":"l0ywmex","renderedPathname":"/how-to-upgrade-debian-to-sid-l0ywmex/"}}},{"node":{"fields":{"slug":"lo3mz9g","renderedPathname":"/git-hub-page-build-failure-solution-lo3mz9g/"}}},{"node":{"fields":{"slug":"uckstjz","renderedPathname":"/วิธีการติดตั้ง-google-chrome-บน-debian-uckstjz/"}}},{"node":{"fields":{"slug":"lay4u9o","renderedPathname":"/how-to-install-google-chrome-on-debian-lay4u9o/"}}},{"node":{"fields":{"slug":"612v702","renderedPathname":"/เวอร์ชั่นแต่ละเวอร์ชั่นของ-debian-คืออะไร-อะไรคือ-sid-testing-stable-โอ๊ยเยอะแยะไปหมด-612v702/"}}},{"node":{"fields":{"slug":"it3xlde","renderedPathname":"/มือใหม่หัดใช้ลินุกซ์ครั้งแรก-it3xlde/"}}},{"node":{"fields":{"slug":"8q0uj3s","renderedPathname":"/วิธีการทำให้-gnome-nautilus-แสดง-directory-ก่อนไฟล์-8q0uj3s/"}}},{"node":{"fields":{"slug":"1jxvb3m","renderedPathname":"/how-to-compile-install-gnome-builder-on-debian-1jxvb3m/"}}},{"node":{"fields":{"slug":"rfih9o0","renderedPathname":"/how-to-use-vim-with-clipboard-on-debian-rfih9o0/"}}},{"node":{"fields":{"slug":"2zgi1pu","renderedPathname":"/ทริคการใช้-git-การ-merge-บางไฟล์ไปอีก-branch-2zgi1pu/"}}},{"node":{"fields":{"slug":"ix43nzw","renderedPathname":"/วิธีการตั้งค่า-vpn-ของม-สงขลานครินทร์-psu-ix43nzw/"}}},{"node":{"fields":{"slug":"z578nvw","renderedPathname":"/guideline-for-upgrading-jekyll-from-2-x-to-3-x-z578nvw/"}}},{"node":{"fields":{"slug":"2vpnolt","renderedPathname":"/วิธีติดตั้งเกม-hearthstone-heroes-of-warcraft-บน-debian-2vpnolt/"}}},{"node":{"fields":{"slug":"4hztzdg","renderedPathname":"/เปิด-hotspot-wi-fi-เองโดยที่ต้องไม่พึ่งโปรแกรมใดๆ-บน-windows-4hztzdg/"}}},{"node":{"fields":{"slug":"utkfndt","renderedPathname":"/awesome-หนึ่งในคำสำคัญ-keyword-ที่โปรแกรมเมอร์ทุกคนควรจะรู้จักไว้-utkfndt/"}}},{"node":{"fields":{"slug":"ptkagjo","renderedPathname":"/titlesec-latex-package-doesnt-create-section-numbers-on-version-2-10-1-ptkagjo/"}}},{"node":{"fields":{"slug":"0967oym","renderedPathname":"/a-very-short-ubuntu-debian-packages-installation-sheet-0967oym/"}}},{"node":{"fields":{"slug":"92rs1lc","renderedPathname":"/การเดินทางของ-xiaomi-mi-2-s-และแนวทางแก้ปัญหาเซนเซอร์แนบหู-proximity-sensor-ไม่ทำงาน-92rs1lc/"}}},{"node":{"fields":{"slug":"nbqw9e1","renderedPathname":"/เขียนบล็อกด้วยภาษา-markdown-ด้วยแอพจดโน๊ต-bear-บน-i-os-nbqw9e1/"}}},{"node":{"fields":{"slug":"et0zg84","renderedPathname":"/ทำไมเราถึงควรใช้ฐานข้อมูลอนุกรมเวลาสำหรับ-ข้อมูลอนุกรมเวลา-time-series-database-et0zg84/"}}},{"node":{"fields":{"slug":"jmm9qn9","renderedPathname":"/รู้จักกับฐานข้อมูลอนุกรมเวลา-open-tsdb-กันเถอะ-jmm9qn9/"}}},{"node":{"fields":{"slug":"mo4feik","renderedPathname":"/วิธีตั้งค่าการใช้งาน-github-แบบไม่ต้องกรอกรหัสผ่านทุกครั้ง-ผ่าน-ssh-บน-windows-mo4feik/"}}},{"node":{"fields":{"slug":"leu0374","renderedPathname":"/promise-async-await-ของ-js-es-6-ฉบับสั้นๆ-ไม่พูดเยอะ-เจ็บคอ-แถม-rx-js-leu0374/"}}},{"node":{"fields":{"slug":"lm28n32","renderedPathname":"/getting-started-tdd-in-30-seconds-with-python-lm28n32/"}}},{"node":{"fields":{"slug":"i4kssit","renderedPathname":"/ได้-99-คะแนนจาก-google-insights-เรียนรู้การทำ-web-optimization-i4kssit/"}}},{"node":{"fields":{"slug":"9tdymnn","renderedPathname":"/สิ่งที่ได้รับจากการเรียนวิศวกรรมคอมพิวเตอร์ปริญญาโท-9tdymnn/"}}},{"node":{"fields":{"slug":"14liwiu","renderedPathname":"/amazing-ui-design-articles-14liwiu/"}}},{"node":{"fields":{"slug":"ho462dz","renderedPathname":"/react-design-patterns-ho462dz/"}}},{"node":{"fields":{"slug":"a7ng95o","renderedPathname":"/ย้ายจาก-react-class-component-มาเป็น-functional-component-ง่ายกว่าที่คิด-a7ng95o/"}}},{"node":{"fields":{"slug":"wes5jlp","renderedPathname":"/จัดการ-side-effects-ใน-react-ด้วย-hook-use-effect-wes5jlp/"}}},{"node":{"fields":{"slug":"whaab42","renderedPathname":"/react-import-export-component-pattern-whaab42/"}}},{"node":{"fields":{"slug":"t2z614m","renderedPathname":"/run-c-scripts-ไฟล์เดียว-โดยใช้-net-cli-t2z614m/"}}},{"node":{"fields":{"slug":"qlh6tbh","renderedPathname":"/ชีวิตดีเมื่อใช้-fluent-assertions-ช่วยในเขียน-test-เพื่อเปรียบเทียบ-object-ที่ซับซ้อน-qlh6tbh/"}}},{"node":{"fields":{"slug":"7vzlyj3","renderedPathname":"/type-script-4-9-มาใช้-satisfies-เพื่อทำให้-type-ถูกต้องมากขึ้นกันเถอะ-7vzlyj3/"}}},{"node":{"fields":{"slug":"cnhkvv7","renderedPathname":"/responsive-expanding-search-bar-cnhkvv7/"}}},{"node":{"fields":{"slug":"5zqwlzs","renderedPathname":"/ปัญหาการพิมพ์ภาษาไทยบน-atom-editor-5zqwlzs/"}}},{"node":{"fields":{"slug":"gtg6emr","renderedPathname":"/mildy-my-debian-customization-gtg6emr/"}}},{"node":{"fields":{"slug":"deb407s","renderedPathname":"/ทำไม-mount-volume-ของ-docker-บน-windows-แล้วมองไม่เห็นไฟล์-deb407s/"}}},{"node":{"fields":{"slug":"1esbgon","renderedPathname":"/ใช้งานภาษาไทยบน-xe-la-te-x-ฉบับรีบร้อน-1esbgon/"}}},{"node":{"fields":{"slug":"5v44hmt","renderedPathname":"/วิธีการเริ่มการทำงาน-vm-ของ-virtual-box-แบบทำงานเบื้องหลัง-5v44hmt/"}}},{"node":{"fields":{"slug":"4hfvb6r","renderedPathname":"/การเขียนงานวิจัยประชุมวิชาการครั้งแรก-4hfvb6r/"}}},{"node":{"fields":{"slug":"x6nfc7a","renderedPathname":"/อยากแชร์-เรื่องหลังจาการตัดสินใจ-ทำไมถึงใช้เวลาทำวิจัยป-โท-แค่-7-เดือน-x6nfc7a/"}}},{"node":{"fields":{"slug":"2kbbdkt","renderedPathname":"/วิธีการรัน-java-script-ข้างนอก-bundle-ของ-webpack-และการเรียกใช้-j-query-ภายใน-webpack-2kbbdkt/"}}},{"node":{"fields":{"slug":"p8c504z","renderedPathname":"/ทำ-task-management-ด้วย-template-my-things-fully-inspired-by-things-3-application-p8c504z/"}}},{"node":{"fields":{"slug":"fk36d30","renderedPathname":"/มาเขียน-notion-formula-with-confidence-ด้วย-tdd-กัน-แจก-formula-thousand-comma-ด้วยนะ-fk36d30/"}}},{"node":{"fields":{"slug":"8jexlus","renderedPathname":"/เราควรเพิ่มประสิทธิภาพของ-single-page-application-โดยใช้-server-side-rendering-ssr-หรือไม่-8jexlus/"}}},{"node":{"fields":{"slug":"qocjeqb","renderedPathname":"/ตั้งค่าให้-github-actions-แสดง-previews-deploy-เมื่อส่ง-pull-request-โดยใช้-vercel-qocjeqb/"}}},{"node":{"fields":{"slug":"hzpnrnx","renderedPathname":"/วิธีการตั้งค่า-ssh-สำหรับ-git-hub-เพื่อให้จำรหัสผ่านบน-windows-wsl-mac-os-และ-ubuntu-hzpnrnx/"}}},{"node":{"fields":{"slug":"0ydbrqj","renderedPathname":"/การใช้งาน-multi-modules-ต่อ-workspace-ใน-vs-codeและ-วิธีการแก้ปัญหา-you-are-outside-of-a-module-and-outside-of-gopath-src-0ydbrqj/"}}},{"node":{"fields":{"slug":"suzlta6","renderedPathname":"/dealing-with-more-than-100-secrets-on-git-hub-actions-using-mozilla-sops-and-azure-key-vault-suzlta6/"}}},{"node":{"fields":{"slug":"c2tcmvl","renderedPathname":"/ลดขนาด-docker-image-ของ-nest-js-prisma-กับ-nx-monorepo-ประมาณ-97-ด้วย-esbuild-bundle-c2tcmvl/"}}},{"node":{"fields":{"slug":"bulndnf","renderedPathname":"/draft/react-best-practices-checklist-bulndnf/"}}},{"node":{"fields":{"slug":"yvtxh9c","renderedPathname":"/draft/react-dark-mode-yvtxh9c/"}}},{"node":{"fields":{"slug":"p72tqcd","renderedPathname":"/draft/react-stylesheet-p72tqcd/"}}},{"node":{"fields":{"slug":"4vwhqae","renderedPathname":"/draft/git-cookbook-4vwhqae/"}}},{"node":{"fields":{"slug":"obu52c9","renderedPathname":"/draft/git-in-action-obu52c9/"}}},{"node":{"fields":{"slug":"ubtbao5","renderedPathname":"/draft/security-ubtbao5/"}}},{"node":{"fields":{"slug":"j5trzrh","renderedPathname":"/draft/webpack-multiple-entry-points-j5trzrh/"}}},{"node":{"fields":{"slug":"l8cwdzj","renderedPathname":"/draft/gatsby-with-google-analytics-l8cwdzj/"}}},{"node":{"fields":{"slug":"sn99eu2","renderedPathname":"/draft/ปี-2021-แล้ว-redux-ยังน่าใช้อยู่มั้ย-sn99eu2/"}}},{"node":{"fields":{"slug":"r6lb1z1","renderedPathname":"/draft/ปี-2021-แล้ว-boostrap-ยังน่าใช้อยู่มั้ย-r6lb1z1/"}}},{"node":{"fields":{"slug":"hal2uva","renderedPathname":"/draft/setup-type-script-hal2uva/"}}},{"node":{"fields":{"slug":"6ecucle","renderedPathname":"/draft/type-script-6ecucle/"}}},{"node":{"fields":{"slug":"7sza35r","renderedPathname":"/draft/มาดูกันว่ามีอะไรบ้างที่ทำให้การเขียน-css-ง่ายขึ้น-เอ๊ะ-หรือยากขึ้น-7sza35r/"}}},{"node":{"fields":{"slug":"xo7nmlr","renderedPathname":"/draft/react-xo7nmlr/"}}},{"node":{"fields":{"slug":"zmpgpk8","renderedPathname":"/draft/read-private-key-from-env-file-zmpgpk8/"}}},{"node":{"fields":{"slug":"ne5q3pt","renderedPathname":"/draft/shortcut-css-in-js-responsive-ne5q3pt/"}}},{"node":{"fields":{"slug":"w5y3zzn","renderedPathname":"/draft/styled-component-type-script-w5y3zzn/"}}},{"node":{"fields":{"slug":"7y0e9i6","renderedPathname":"/draft/c-type-script-cheat-sheet-7y0e9i6/"}}},{"node":{"fields":{"slug":"kxkqrql","renderedPathname":"/draft/dependency-injection-in-asp-net-core-kxkqrql/"}}},{"node":{"fields":{"slug":"abfn33i","renderedPathname":"/draft/introduction-to-type-script-abfn33i/"}}},{"node":{"fields":{"slug":"g4owyyw","renderedPathname":"/draft/modern-javascript-es-6-ใน-react-ที่พบได้บ่อย-แถม-type-script-g4owyyw/"}}},{"node":{"fields":{"slug":"lygyofl","renderedPathname":"/draft/offsetting-an-html-anchor-to-adjust-for-fixed-header-lygyofl/"}}},{"node":{"fields":{"slug":"218xi1n","renderedPathname":"/draft/node-js-esm-218xi1n/"}}},{"node":{"fields":{"slug":"68zrdlq","renderedPathname":"/draft/type-script-สำหรับ-everyday-uses-68zrdlq/"}}},{"node":{"fields":{"slug":"h4uaaip","renderedPathname":"/draft/uptime-kuma-on-azure-virtual-machine-h4uaaip/"}}},{"node":{"fields":{"slug":"55dtwqq","renderedPathname":"/draft/how-to-choose-proper-component-ui-react-55dtwqq/"}}},{"node":{"fields":{"slug":"p96v4ze","renderedPathname":"/draft/gatsby-thai-font-sharing-social-p96v4ze/"}}},{"node":{"fields":{"slug":"k9xf79y","renderedPathname":"/draft/jimp-load-font-function-renders-non-english-thai-font-ugly-with-vowel-character-k9xf79y/"}}},{"node":{"fields":{"slug":"bqfiofl","renderedPathname":"/draft/get-page-view-from-google-analytics-by-page-path-bqfiofl/"}}},{"node":{"fields":{"slug":"e6zs48e","renderedPathname":"/draft/บันทึก-seo-และ-social-media-e6zs48e/"}}},{"node":{"fields":{"slug":"g3k2o1b","renderedPathname":"/draft/วิธีการ-build-asp-net-framework-และ-deploy-ไปยัง-azure-app-service-g3k2o1b/"}}},{"node":{"fields":{"slug":"l2kc44e","renderedPathname":"/draft/introduction-to-git-hub-action-l2kc44e/"}}},{"node":{"fields":{"slug":"3s569jw","renderedPathname":"/draft/ทำไมเราควรติด-type-ภาษา-java-script-ด้วย-type-script-3s569jw/"}}},{"node":{"fields":{"slug":"ulguf3h","renderedPathname":"/draft/how-to-debug-a-node-js-application-in-visual-studio-code-java-script-debugging-ulguf3h/"}}},{"node":{"fields":{"slug":"qdz8lz2","renderedPathname":"/draft/นำพาโปรเจ็ค-asp-net-แบบ-web-site-project-อายุร่วม-8-ปี-เข้าสู่ยุค-automate-build-ด้วย-git-hub-actions-qdz8lz2/"}}},{"node":{"fields":{"slug":"d070sbs","renderedPathname":"/draft/site-reliability-engineering-d070sbs/"}}},{"node":{"fields":{"slug":"tjd75q6","renderedPathname":"/draft/deploy-multiple-azure-app-services-using-git-hub-actions-matrix-tjd75q6/"}}},{"node":{"fields":{"slug":"h3kmk3n","renderedPathname":"/draft/3-เรื่อง-ที่ควรทำหลังติดตั้ง-wsl-บน-windows-เพื่อทำให้การใช้งานร่วมกับ-vs-code-สะดวกมากขึ้น-h3kmk3n/"}}},{"node":{"fields":{"slug":"kauwjer","renderedPathname":"/draft/how-to-hide-github-action-secrets-kauwjer/"}}},{"node":{"fields":{"slug":"9ahhltg","renderedPathname":"/draft/provider-azurerm-version-3-ออกมาแล้ว-มีอะไรเปลี่ยนไปบ้าง-มีอะไรที่-deprecated-9ahhltg/"}}},{"node":{"fields":{"slug":"uxzmr8c","renderedPathname":"/draft/unintended-circular-dependency-of-dependency-injection-using-type-script-uxzmr8c/"}}},{"node":{"fields":{"slug":"h10x942","renderedPathname":"/draft/วิธี-backup-database-และเตรียม-migration-script-บน-sql-server-ด้วย-command-line-h10x942/"}}},{"node":{"fields":{"slug":"7rwsbzv","renderedPathname":"/draft/type-script-object-mapping-7rwsbzv/"}}},{"node":{"fields":{"slug":"noqcy49","renderedPathname":"/draft/dotnet-6-env-noqcy49/"}}}]}},"pageContext":{"slug":"c2tcmvl","nexttitle":"React Best Practices Checklist","nextslug":"bulndnf","prevtitle":"Dealing with more than 100 secrets on GitHub Actions using Mozilla SOPS and Azure Key Vault","prevslug":"suzlta6"}},"staticQueryHashes":[]}